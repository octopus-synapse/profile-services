#!/bin/sh
# Standardized pre-commit hook for ProFile repositories
# Source: octopus-workflows/scripts/husky/pre-commit
#
# Run order:
# 1. Generate swagger.json from @SdkExport decorators (MUST be first)
# 2. Type check
# 3. Fast lint
# 4. Unit tests
#
# CI will run additional checks:
# - Full ESLint with type-aware rules
# - Integration tests (for profile-services)
# - E2E tests (for profile-frontend)

echo "Pre-commit checks (fast feedback loop)..."
echo ""

# 0. Generate Swagger from @SdkExport decorators (FIRST - before any checks)
echo "  -> Generating swagger.json from @SdkExport decorators..."
bun run scripts/generate-swagger-from-decorators.ts || exit 1

# Stage the generated swagger.json if it changed
git add swagger.json swagger-generation-report.json 2>/dev/null || true

# 1. Type check
echo "  -> Type checking..."
bun run typecheck || exit 1

# 2. Fast lint with oxlint
echo "  -> Fast lint (oxlint)..."
bun run lint:fast || exit 1

# 3. Swagger documentation validation
echo "  -> Validating Swagger documentation..."
bun test ./tests/swagger-generation.test.ts || exit 1

# 4. Unit tests
echo "  -> Running tests..."
bun test || exit 1

echo ""
echo "Pre-commit passed!"
