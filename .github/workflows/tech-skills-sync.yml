# Tech Skills Sync Workflow
# Synchronizes tech skills from GitHub Linguist and Stack Overflow
# Runs every 6 months (January 1st and July 1st)

name: Tech Skills Sync

on:
    schedule:
        # Run on January 1st at 04:00 UTC
        - cron: "0 4 1 1 *"
        # Run on July 1st at 04:00 UTC
        - cron: "0 4 1 7 *"
    workflow_dispatch:
        inputs:
            force_sync:
                description: "Force sync even if recently synced"
                required: false
                default: "false"

env:
    NODE_VERSION: "20"
    BACKEND_URL: ${{ secrets.BACKEND_URL }}
    INTERNAL_API_TOKEN: ${{ secrets.INTERNAL_API_TOKEN }}

jobs:
    sync-tech-skills:
        name: Sync Tech Skills
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Trigger Tech Skills Sync
              id: sync
              run: |
                  echo "Triggering tech skills sync..."

                  RESPONSE=$(curl -s -w "\n%{http_code}" \
                    -X POST \
                    -H "Content-Type: application/json" \
                    -H "X-Internal-Token: ${{ env.INTERNAL_API_TOKEN }}" \
                    "${{ env.BACKEND_URL }}/api/tech-skills/sync")

                  HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                  BODY=$(echo "$RESPONSE" | sed '$d')

                  echo "HTTP Status: $HTTP_CODE"
                  echo "Response: $BODY"

                  if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                    echo "✅ Tech skills sync completed successfully"
                    echo "sync_status=success" >> $GITHUB_OUTPUT
                    echo "$BODY" | jq '.' || echo "$BODY"
                  else
                    echo "❌ Tech skills sync failed"
                    echo "sync_status=failed" >> $GITHUB_OUTPUT
                    exit 1
                  fi

            - name: Create Summary
              if: always()
              run: |
                  echo "## Tech Skills Sync Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
                  echo "**Status:** ${{ steps.sync.outputs.sync_status || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Sources" >> $GITHUB_STEP_SUMMARY
                  echo "- GitHub Linguist (Programming Languages)" >> $GITHUB_STEP_SUMMARY
                  echo "- Stack Overflow Tags (Tech Skills)" >> $GITHUB_STEP_SUMMARY

    notify-on-failure:
        name: Notify on Failure
        runs-on: ubuntu-latest
        needs: sync-tech-skills
        if: failure()

        steps:
            - name: Send failure notification
              run: |
                  echo "Tech skills sync failed - notification would be sent here"
                  # Add Slack/Discord/Email notification here if needed
