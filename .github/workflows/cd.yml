name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    uses: efpatti/octopus-workflows/.github/workflows/cd.yml@main
    with:
      service-name: "profile-backend"
      service-port: "3001"
      deploy-path: "/opt/profile-services"
      has-database: true
    secrets:
      # Octopus secrets (OCTOPUS_VM_*) inherited automatically from octopus environment
      # Project-specific secrets below
      ENV_VARS: |
        NODE_ENV=production
        BACKEND_PORT=3001
        POSTGRES_USER=${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_DB=${{ secrets.POSTGRES_DB }}
        DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}?schema=public
        REDIS_HOST=redis
        REDIS_PORT=6379
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        JWT_EXPIRATION=7d
        SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
        SENDGRID_EMAIL_FROM=${{ secrets.SENDGRID_EMAIL_FROM }}
        MINIO_ENDPOINT=${{ secrets.MINIO_ENDPOINT }}
        MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
        MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
        MINIO_BUCKET=${{ secrets.MINIO_BUCKET }}
