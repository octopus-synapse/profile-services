name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  packages: write

concurrency:
  group: production
  cancel-in-progress: true

jobs:
  deploy:
    uses: octopus-synapse/octopus-workflows/.github/workflows/cd.yml@main
    with:
      service-name: "profile-backend"
      deploy-path: "/opt/profile-services"
      has-database: true
      required-env-vars: "DATABASE_URL,JWT_SECRET,SENDGRID_API_KEY,REDIS_HOST,MINIO_ENDPOINT"
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.GH_PAT }}
      SERVICE_PORT: ${{ secrets.BACKEND_PORT }}
      OCTOPUS_SSH_PRIVATE_KEY: ${{ secrets.OCTOPUS_SSH_PRIVATE_KEY }}
      OCTOPUS_VM_HOST: ${{ secrets.OCTOPUS_VM_HOST }}
      OCTOPUS_VM_USER: ${{ secrets.OCTOPUS_VM_USER }}
      ENV_VARS: |
        NODE_ENV=production
        BACKEND_PORT=${{ secrets.BACKEND_PORT }}
        POSTGRES_USER=${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_DB=${{ secrets.POSTGRES_DB }}
        DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}?schema=public
        REDIS_HOST=redis
        REDIS_PORT=6379
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        JWT_EXPIRATION=7d
        SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
        SENDGRID_EMAIL_FROM=${{ secrets.SENDGRID_EMAIL_FROM }}
        MINIO_ENDPOINT=${{ secrets.MINIO_ENDPOINT }}
        MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
        MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
        MINIO_BUCKET=${{ secrets.MINIO_BUCKET }}
