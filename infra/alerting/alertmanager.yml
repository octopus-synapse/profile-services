# AlertManager Configuration for ProFile Services
# Manages alert routing, grouping, and notifications
#
# Environment Variables Required:
#   SLACK_WEBHOOK_URL - Slack incoming webhook URL
#   PAGERDUTY_SERVICE_KEY - PagerDuty integration key (optional)

global:
  # Default SMTP settings (configure if using email alerts)
  # smtp_smarthost: 'smtp.example.com:587'
  # smtp_from: 'alertmanager@profile.com'

  # Slack API URL (uses incoming webhooks)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

  # How long to wait before sending notification about resolved alerts
  resolve_timeout: 5m

# Alert routing configuration
route:
  # Default receiver for all alerts
  receiver: 'slack-notifications'

  # Group alerts by these labels
  group_by: ['alertname', 'severity', 'service']

  # Wait this long before sending initial notification
  group_wait: 30s

  # Wait this long before sending subsequent notifications
  group_interval: 5m

  # Wait this long before resending notifications
  repeat_interval: 4h

  # Child routes for severity-based routing
  routes:
    # Critical alerts go to PagerDuty and Slack
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      continue: true  # Also send to default receiver

    # Warning alerts go to Slack only
    - match:
        severity: warning
      receiver: 'slack-notifications'
      group_wait: 1m
      repeat_interval: 12h

# Notification receivers
receivers:
  # Slack notifications for all alerts
  - name: 'slack-notifications'
    slack_configs:
      - channel: '#profile-alerts'
        send_resolved: true
        username: 'ProFile AlertManager'
        icon_emoji: ':rotating_light:'
        title: '{{ if eq .Status "firing" }}:fire: ALERT{{ else }}:white_check_mark: RESOLVED{{ end }}'
        text: |-
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service | default "profile-services" }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url | default "See docs/runbooks/" }}
          {{ end }}
        actions:
          - type: button
            text: 'View Runbook'
            url: '{{ (index .Alerts 0).Annotations.runbook_url }}'
          - type: button
            text: 'Silence Alert'
            url: '{{ template "__alertmanagerURL" . }}/#/silences/new?filter=%7Balertname%3D%22{{ (index .Alerts 0).Labels.alertname }}%22%7D'

  # PagerDuty for critical alerts
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        severity: critical
        description: '{{ .CommonAnnotations.summary }}'
        details:
          alertname: '{{ .CommonLabels.alertname }}'
          service: '{{ .CommonLabels.service }}'
          severity: '{{ .CommonLabels.severity }}'
          description: '{{ .CommonAnnotations.description }}'

# Inhibition rules to prevent duplicate alerts
inhibit_rules:
  # If critical is firing, suppress warning for same alertname
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  # If service is down, suppress other service-specific alerts
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.+'
    equal: ['service']

# Templates for custom notification formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'
