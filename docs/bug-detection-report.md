# Bug Detection Report

> Generated by Uncle Bob-style specification tests.
> "A test that cannot fail is not a test. It's a lie." - Kent Beck

## Summary

- **Total Bugs Found:** 22
- **Critical:** 8
- **High:** 9
- **Medium:** 5

## Bugs by Service

### 1. UsernameService (5 bugs)

#### BUG-001: Uppercase usernames silently converted (CRITICAL)
- **Rule:** Usernames with uppercase must be REJECTED, not converted
- **Current:** `toLowerCase()` is applied silently
- **Expected:** `BadRequestException` with clear message
- **File:** `src/users/services/username.service.ts:32`
- **Test:** `username.service.bug-detection.spec.ts`

#### BUG-002: Reserved usernames not validated (CRITICAL)
- **Rule:** Reserved usernames (admin, api, www, support, help, root, system, null, undefined) must be rejected
- **Current:** No validation exists
- **Expected:** Check against configurable reserved list
- **File:** `src/users/services/username.service.ts`

#### BUG-003: Username format not validated (HIGH)
- **Rule:** Usernames must start with letter, no special chars, no consecutive underscores
- **Current:** No format validation
- **Expected:** Regex validation

#### BUG-004: No username starts with number rejection (HIGH)
- **Rule:** Username cannot start with a number
- **Current:** Accepts `123user`
- **Expected:** Reject with clear message

#### BUG-005: Trailing underscore accepted (MEDIUM)
- **Rule:** Username cannot end with underscore
- **Current:** Accepts `username_`
- **Expected:** Reject with clear message

---

### 2. ResumesService (1 bug)

#### BUG-006: Resume limit returns HTTP 400 instead of 422 (HIGH)
- **Rule:** Business rule errors should return 422 Unprocessable Entity
- **Current:** Throws `BadRequestException` (400)
- **Expected:** `UnprocessableEntityException` (422)
- **File:** `src/resumes/resumes.service.ts:65`
- **Fix:**
```typescript
// Change:
throw new BadRequestException(...)
// To:
throw new UnprocessableEntityException(...)
```

---

### 3. ExperienceService (4 bugs)

#### BUG-007: isCurrent=true with endDate not rejected (CRITICAL)
- **Rule:** If isCurrent=true → endDate MUST be null
- **Current:** Accepts any combination
- **Expected:** Validate and reject invalid combinations
- **File:** `src/resumes/services/base/base-sub-resource.service.ts`

#### BUG-008: isCurrent=false with endDate=null not rejected (HIGH)
- **Rule:** If isCurrent=false → endDate MUST be set
- **Current:** Accepts null endDate
- **Expected:** Require endDate for non-current positions

#### BUG-009: endDate before startDate not rejected (HIGH)
- **Rule:** endDate must be after startDate
- **Current:** No date range validation
- **Expected:** Reject with clear message

#### BUG-010: Duplicate order values not rejected (HIGH)
- **Rule:** Two items cannot have the same order value
- **Current:** Accepts duplicates
- **Expected:** Reject duplicates, no auto-tiebreaker

---

### 4. OnboardingProgressService (5 bugs)

#### BUG-011: noExperience=true with non-empty array accepted (CRITICAL)
- **Rule:** If noExperience=true → experiences array MUST be empty
- **Current:** Accepts any data
- **Expected:** `BadRequestException`
- **File:** `src/onboarding/services/onboarding-progress.service.ts`

#### BUG-012: noEducation=true with non-empty array accepted (CRITICAL)
- **Rule:** If noEducation=true → education array MUST be empty
- **Current:** Accepts any data
- **Expected:** `BadRequestException`

#### BUG-013: noSkills=true with non-empty array accepted (CRITICAL)
- **Rule:** If noSkills=true → skills array MUST be empty
- **Current:** Accepts any data
- **Expected:** `BadRequestException`

#### BUG-014: Progress does not expire after 36 hours (HIGH)
- **Rule:** Onboarding progress expires after 36 hours
- **Current:** No expiration check
- **Expected:** Return initial progress if expired, delete stale data

#### BUG-015: Sequential step validation missing (MEDIUM)
- **Rule:** Steps must be completed in sequential order
- **Current:** Can skip steps
- **Expected:** Reject if trying to advance without completing previous steps

---

### 5. UserAdminMutationService (4 bugs)

#### BUG-016: Last admin can remove own role via UPDATE (CRITICAL)
- **Rule:** Last admin cannot remove their admin role
- **Current:** Only checks on DELETE, not on UPDATE (role change)
- **Expected:** Check on both DELETE and UPDATE
- **File:** `src/admin/services/user-admin-mutation.service.ts:53-76`

#### BUG-017: No audit log for role changes (MEDIUM)
- **Rule:** All admin promotions/demotions must be audited
- **Current:** No audit logging
- **Expected:** Create audit log entry on role change

#### BUG-018: Weak password accepted on admin reset (HIGH)
- **Rule:** Passwords must meet strength requirements
- **Current:** No validation on admin reset
- **Expected:** Validate password strength

#### BUG-019: No audit log for password reset (MEDIUM)
- **Rule:** Admin password resets should be audited
- **Current:** No audit logging
- **Expected:** Create audit log entry

---

### 6. ThemeApprovalService (3 bugs)

#### BUG-020: Resubmission limit not enforced (HIGH)
- **Rule:** Rejected themes can only be resubmitted 2 times
- **Current:** No rejectionCount check on submit
- **Expected:** Reject if rejectionCount >= 2
- **File:** `src/themes/services/theme-approval.service.ts:24-45`

#### BUG-021: rejectionCount not incremented on rejection (HIGH)
- **Rule:** Track number of rejections
- **Current:** rejectionCount not updated
- **Expected:** `rejectionCount: { increment: 1 }`

#### BUG-022: No audit log for approval/rejection (MEDIUM)
- **Rule:** All theme approval actions must be audited
- **Current:** No audit logging
- **Expected:** Create audit log entries

---

## Priority Fix Order

1. **CRITICAL (8 bugs):** BUG-001, BUG-002, BUG-007, BUG-011, BUG-012, BUG-013, BUG-016
2. **HIGH (9 bugs):** BUG-003, BUG-004, BUG-006, BUG-008, BUG-009, BUG-010, BUG-014, BUG-018, BUG-020, BUG-021
3. **MEDIUM (5 bugs):** BUG-005, BUG-015, BUG-017, BUG-019, BUG-022

---

## Test Files Created

- `src/users/services/username.service.bug-detection.spec.ts`
- `src/resumes/resumes.service.bug-detection.spec.ts`
- `src/resumes/services/experience.service.bug-detection.spec.ts`
- `src/onboarding/services/onboarding-progress.bug-detection.spec.ts`
- `src/admin/services/user-admin-mutation.service.bug-detection.spec.ts`
- `src/themes/services/theme-crud.service.bug-detection.spec.ts`
- `src/themes/services/theme-approval.service.bug-detection.spec.ts`

## How to Run

```bash
# Run all bug detection tests
npm test -- --testPathPattern="bug-detection"

# Run specific service
npm test -- --testPathPattern="username.service.bug-detection"
```

## Next Steps

1. Fix bugs in priority order (CRITICAL first)
2. Run tests to verify fixes (tests should turn green)
3. Add regression tests for each fix
4. Update business rule documentation

