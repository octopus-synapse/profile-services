// User and Preferences Models

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?

  accounts Account[]
  sessions Session[]

  // Profile fields
  username          String?   @unique
  usernameUpdatedAt DateTime?
  displayName       String?
  photoURL          String?
  bio               String?   @db.Text
  location          String?
  phone             String?
  website           String?
  linkedin          String?
  github            String?

  // Primary resume for settings/profile
  primaryResumeId String?
  primaryResume   Resume? @relation("UserPrimaryResume", fields: [primaryResumeId], references: [id], onDelete: SetNull)

  // Onboarding tracking
  hasCompletedOnboarding Boolean   @default(false)
  onboardingCompletedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resumes            Resume[]            @relation("UserResumes")
  preferences        UserPreferences?
  onboardingProgress OnboardingProgress?
  auditLogs          AuditLog[]
  consents           UserConsent[]       @relation("UserConsents")

  // Theme system
  createdThemes  ResumeTheme[] @relation("ThemeAuthor")
  approvedThemes ResumeTheme[] @relation("ThemeApprover")

  // Chat system
  conversationsAsParticipant1 Conversation[] @relation("ConversationParticipant1")
  conversationsAsParticipant2 Conversation[] @relation("ConversationParticipant2")
  sentMessages                Message[]      @relation("SentMessages")
  blockedUsers                BlockedUser[]  @relation("Blocker")
  blockedByUsers              BlockedUser[]  @relation("Blocked")

  // Social features
  followers  Follow[]   @relation("Following")
  following  Follow[]   @relation("Followers")
  activities Activity[] @relation("UserActivities")

  // Two-Factor Authentication
  twoFactorAuth        TwoFactorAuth?
  twoFactorBackupCodes TwoFactorBackupCode[]

  // Email logging
  emailLogs EmailLog[]

  // Resume imports
  resumeImports ResumeImport[]

  // Resume collaborations
  collaborations ResumeCollaborator[] @relation("UserCollaborations")

  // Dynamic RBAC Authorization System
  userRoles       UserRoleAssignment[]
  userGroups      UserGroup[]
  userPermissions UserPermission[]

  @@index([username])
  @@index([email])
  @@index([hasCompletedOnboarding])
  @@index([primaryResumeId])
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Appearance (consolidated from User.bannerColor and User.palette)
  theme       String  @default("dark")
  palette     String  @default("ocean")
  bannerColor String?

  // Localization
  language   String @default("en")
  dateFormat String @default("MM/DD/YYYY")
  timezone   String @default("UTC")

  // Notifications
  emailNotifications Boolean         @default(true)
  resumeExpiryAlerts Boolean         @default(true)
  weeklyDigest       Boolean         @default(false)
  marketingEmails    Boolean         @default(false)
  emailMilestones    Boolean         @default(true)
  emailShareExpiring Boolean         @default(true)
  digestFrequency    DigestFrequency @default(WEEKLY)

  // Privacy
  profileVisibility      String  @default("private")
  showEmail              Boolean @default(false)
  showPhone              Boolean @default(false)
  allowSearchEngineIndex Boolean @default(false)

  // Export defaults
  defaultExportFormat  String  @default("pdf")
  includePhotoInExport Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model OnboardingProgress {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  currentStep    String   @default("welcome")
  completedSteps String[] @default([])
  username       String?

  // Form data (JSON)
  personalInfo        Json?
  professionalProfile Json?
  experiences         Json?
  noExperience        Boolean @default(false)
  education           Json?
  noEducation         Boolean @default(false)
  skills              Json?
  noSkills            Boolean @default(false)
  languages           Json?
  templateSelection   Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // TTL: Auto-cleanup for abandoned sessions (30 days)

  @@index([userId])
  @@index([expiresAt])
}

model AuditLog {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  action     AuditAction
  entityType String // "User", "Resume", "Preferences", etc
  entityId   String // ID of affected resource

  // Changes snapshot
  changesBefore Json? // State before action
  changesAfter  Json? // State after action

  // Context metadata
  ipAddress String?
  userAgent String?
  metadata  Json? // Additional context (geo, referer, etc)

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([entityType, entityId])
  @@index([createdAt]) // For retention policy cleanup
}

// GDPR Compliance: Track ToS/Privacy Policy acceptance (#75)
model UserConsent {
  id String @id @default(cuid())

  userId String
  user   User   @relation("UserConsents", fields: [userId], references: [id], onDelete: Cascade)

  documentType ConsentDocumentType
  version      String // e.g., "1.0.0", "1.1.0"

  acceptedAt DateTime @default(now())

  // Audit trail for compliance
  ipAddress String?
  userAgent String?

  @@unique([userId, documentType, version])
  @@index([userId, documentType])
  @@index([acceptedAt])
}
